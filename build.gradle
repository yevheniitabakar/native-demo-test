plugins {
    id 'java'
    id 'idea'
    id 'io.qameta.allure' version '2.11.2'
}

group = 'com.demo'
version = '1.0.0'

repositories {
    mavenCentral()
    jcenter()
    maven { url "https://repo.maven.apache.org/maven2/" }
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(17)
    }
}

allure {
    version = '2.27.0'
}

dependencies {
    // Test framework
    testImplementation 'org.testng:testng:7.10.2'

    // Appium client
    implementation 'io.appium:java-client:9.2.2'

    // Selenium WebDriver
    implementation 'org.seleniumhq.selenium:selenium-java:4.16.1'

    // Logging
    implementation 'org.slf4j:slf4j-api:2.0.12'
    runtimeOnly 'ch.qos.logback:logback-classic:1.5.6'

    // Reporting - Allure
    testImplementation('io.qameta.allure:allure-testng:2.27.0') {
        exclude group: 'io.qameta.allure', module: 'allure-java-commons'
    }
    testImplementation 'io.qameta.allure:allure-java-commons:2.27.0'
    implementation 'io.qameta.allure:allure-java-commons:2.27.0'

    // JSON processing
    implementation 'com.google.code.gson:gson:2.10.1'

    // Utilities
    implementation 'commons-io:commons-io:2.14.0'

    // Annotations
    implementation 'javax.annotation:javax.annotation-api:1.3.2'
}

test {
    useTestNG() {
        suites 'src/test/resources/testng.xml'
        useDefaultListeners = true
    }

    systemProperties(System.getProperties())

    // Add platform parameter
    def platform = System.getProperty('platform', 'android')
    systemProperty 'platform', platform

    // JVM settings
    jvmArgs = [
        '--add-opens', 'java.base/java.lang=ALL-UNNAMED'
    ]

    testLogging {
        events "passed", "skipped", "failed"
        exceptionFormat "full"
    }

    // Allure reports directory
    systemProperty 'allure.results.directory', "${layout.buildDirectory.asFile.get()}/allure-results"

    // Pre-test device availability check
    doFirst {
        println "=========================================="
        println "Checking device availability..."
        println "=========================================="

        def deviceCheckScript = new File(rootDir, 'scripts/device-manager.sh')
        if (!deviceCheckScript.exists()) {
            throw new GradleException("Device manager script not found: ${deviceCheckScript.absolutePath}")
        }

        def checkCommand = ["bash", deviceCheckScript.absolutePath, platform, "check"]
        def process = checkCommand.execute()
        def output = process.text
        def exitCode = process.waitFor()

        println output

        if (exitCode != 0) {
            throw new GradleException("""
========================================
Device not available for $platform
========================================
Please ensure that:
1. $platform device/emulator is booted
2. For direct Gradle execution, use: ./run_tests.sh $platform
   (This script automatically starts the device if needed)
========================================
""")
        }

        println "âœ“ Device is available. Proceeding with tests..."
        println "=========================================="
    }
}

tasks.withType(JavaCompile).configureEach {
    options.encoding = 'UTF-8'
}


// Copy environment properties to allure results
tasks.register('copyEnvironmentToAllure') {
    doLast {
        def allureResultsDir = file("${layout.buildDirectory.asFile.get()}/allure-results")
        allureResultsDir.mkdirs()

        def envPropsFile = file('src/test/resources/environment.properties')
        if (envPropsFile.exists()) {
            copy {
                from envPropsFile
                into allureResultsDir
            }
            println "Copied environment.properties to allure-results"
        }
    }
}

// Run these tasks before test
tasks.named('test') {
    dependsOn 'copyEnvironmentToAllure'
}

